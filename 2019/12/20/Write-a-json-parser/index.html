<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha256-dABdfBfUoC8vJUBOwGVdm8L9qlMWaHTIfXt+7GnZCIo=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"1oo1.github.io","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.22.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="How to build a parserIf you want an easy way to code parsers, or you are tight on space, you should hand-code a recursive descent parser; these are essentially">
<meta property="og:type" content="article">
<meta property="og:title" content="Write a json parser">
<meta property="og:url" content="https://1oo1.github.io/2019/12/20/Write-a-json-parser/index.html">
<meta property="og:site_name" content="Blog">
<meta property="og:description" content="How to build a parserIf you want an easy way to code parsers, or you are tight on space, you should hand-code a recursive descent parser; these are essentially">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2019-12-20T15:44:24.000Z">
<meta property="article:modified_time" content="2020-07-18T08:11:11.537Z">
<meta property="article:author" content="1oo1">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://1oo1.github.io/2019/12/20/Write-a-json-parser/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://1oo1.github.io/2019/12/20/Write-a-json-parser/","path":"2019/12/20/Write-a-json-parser/","title":"Write a json parser"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Write a json parser | Blog</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Blog</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">1oo1</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">6</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://1oo1.github.io/2019/12/20/Write-a-json-parser/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="1oo1">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Write a json parser | Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Write a json parser
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2019-12-20 23:44:24" itemprop="dateCreated datePublished" datetime="2019-12-20T23:44:24+08:00">2019-12-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2020-07-18 16:11:11" itemprop="dateModified" datetime="2020-07-18T16:11:11+08:00">2020-07-18</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><p><strong><a href="https://stackoverflow.com/a/2336769/120163" target="_blank" rel="noopener">How to build a parser</a></strong><br>If you want an easy way to code parsers, or you are tight on space, you should hand-code a recursive descent parser; these are essentially </p>
<a id="more"></a>
<p><a href="https://en.wikipedia.org/wiki/LL_parser" target="_blank" rel="noopener">LL</a>(1) parsers. This is especially effective for languages which are as “simple” as Basic. (I did several of these back in the 70s!). The good news is these don’t contain any library code; just what you write.</p>
<p>They are pretty easy to code, if you already have a grammar. First, you have to get rid of left recursive rules (e.g., X = X Y ). This is generally pretty easy to do, so I leave it as an exercise. (You don’t have to do this for list-forming rules; see discussion below).</p>
<p>Then if you have BNF rule of the form:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">X &#x3D; A B C ;</span><br></pre></td></tr></table></figure>
<p>create a subroutine for each item in the rule (X, A, B, C) that returns a boolean saying “I saw the corresponding syntax construct”. For X, code:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">subroutine X()</span><br><span class="line">     if ~(A()) return false;</span><br><span class="line">     if ~(B()) &#123; error(); return false; &#125;</span><br><span class="line">     if ~(C()) &#123; error(); return false; &#125;</span><br><span class="line">     &#x2F;&#x2F; insert semantic action here: generate code, do the work, ....</span><br><span class="line">     return true;</span><br><span class="line">end X;</span><br></pre></td></tr></table></figure>
<p>Similarly for A, B, C.</p>
<p>If a token is a terminal, write code that checks the input stream for the string of characters that makes up the terminal. E.g, for a Number, check that input stream contains digits and advance the input stream cursor past the digits. This is especially easy if you are parsing out of a buffer (for BASIC, you tend to get one line at time) by simply advancing or not advancing a buffer scan pointer. This code is essentially the lexer part of the parser.</p>
<p>If your BNF rule is recursive… don’t worry. Just code the recursive call. This handles grammar rules like:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">T  &#x3D;  &#39;(&#39;  T  &#39;)&#39; ;</span><br></pre></td></tr></table></figure>
<p>This can be coded as:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">subroutine T()</span><br><span class="line">     if ~(left_paren()) return false;</span><br><span class="line">     if ~(T()) &#123; error(); return false; &#125;</span><br><span class="line">     if ~(right_paren()) &#123; error(); return false; &#125;</span><br><span class="line">     &#x2F;&#x2F; insert semantic action here: generate code, do the work, ....</span><br><span class="line">     return true;</span><br><span class="line">end T;</span><br></pre></td></tr></table></figure>
<p>If you have a BNF rule with an alternative:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">P &#x3D; Q | R ;</span><br></pre></td></tr></table></figure>
<p>then code P with alternative choices:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">subroutine P()</span><br><span class="line">    if ~(Q())</span><br><span class="line">        &#123;if ~(R()) return false;</span><br><span class="line">         return true;</span><br><span class="line">        &#125;</span><br><span class="line">    return true;</span><br><span class="line">end P;</span><br></pre></td></tr></table></figure>
<p>Sometimes you’ll encounter list forming rules. These tend to be left recursive, and this case is easily handled. The basic idea is to use iteration rather than recursion, and that avoids the infinite recursion you would get doing this the “obvious” way. Example:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">L  &#x3D;  A |  L A ;</span><br></pre></td></tr></table></figure>
<p>You can code this using iteration as:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">subroutine L()</span><br><span class="line">    if ~(A()) then return false;</span><br><span class="line">    while (A()) do &#123; &#x2F;* loop *&#x2F; &#125;</span><br><span class="line">    return true;</span><br><span class="line">end L;</span><br></pre></td></tr></table></figure>
<p>You can code several hundred grammar rules in a day or two this way. There’s more details to fill in, but the basics here should be more than enough.</p>
<p>If you are really tight on space, you can build a virtual machine that implements these ideas. That’s what I did back in 70s, when 8K 16 bit words was what you could get.</p>
<p>If you don’t want to code this by hand, you can automate it with a metacompiler (<a href="https://stackoverflow.com/a/5739338/120163" target="_blank" rel="noopener">Meta II</a>) that produces essentially the same thing. These are mind-blowing technical fun and really takes all the work out of doing this, even for big grammars.</p>
<p>August 2014:</p>
<p>I get a lot of requests for “how to build an AST with a parser”. For details on this, which essentially elaborates this answer, see my other SO answer <a href="https://stackoverflow.com/a/25106688/120163" target="_blank" rel="noopener">https://stackoverflow.com/a/25106688/120163</a></p>
<p>July 2015:</p>
<p>There are lots of folks what want to write a simple expression evaluator. You can do this by doing the same kinds of things that the “AST builder” link above suggests; just do arithmetic instead of building tree nodes. Here’s a<a href="https://stackoverflow.com/a/31621205/120163" target="_blank" rel="noopener">n expression evaluator done this way</a>.</p>
<p><strong>Arthmetic Expression Evaluator (Swift)</strong></p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> sum = product | sum "+" product | sum "-" product</span></span><br><span class="line"><span class="comment"> product = term | product "*" term | product "/" term</span></span><br><span class="line"><span class="comment"> term = "-" term | "(" sum ")" | number</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ExpressionEvaluator</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> text: <span class="type">String</span> = <span class="string">""</span></span><br><span class="line">    <span class="keyword">var</span> index = <span class="number">0</span></span><br><span class="line">    <span class="keyword">var</span> currentCharacter: <span class="type">Character</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> text[text.index(text.startIndex, offsetBy: index)]</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">parse</span><span class="params">(str: String)</span></span> &#123;</span><br><span class="line">        <span class="keyword">guard</span> str.<span class="built_in">count</span> != <span class="number">0</span> <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        text = str</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> result = parseSum() &#123;</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"\(text) = \(result)"</span>)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"Syntax error at \(index)"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">parseSum</span><span class="params">()</span></span> -&gt; <span class="type">Int?</span> &#123;</span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> num = parseProduct() <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> number = num</span><br><span class="line">        <span class="keyword">while</span> index &lt; text.<span class="built_in">count</span> &#123;</span><br><span class="line">            skipBlank()</span><br><span class="line">            <span class="keyword">if</span> match(char: <span class="string">"+"</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">let</span> num2 = parseProduct() &#123;</span><br><span class="line">                    number += num2</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> match(char: <span class="string">"-"</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">let</span> num2 = parseProduct() &#123;</span><br><span class="line">                    number -= num2</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> number</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> number</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">parseProduct</span><span class="params">()</span></span> -&gt; <span class="type">Int?</span> &#123;</span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> num = parseTerm() <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">var</span> number = num</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">while</span> index &lt; text.<span class="built_in">count</span> &#123;</span><br><span class="line">            skipBlank()</span><br><span class="line">            <span class="keyword">if</span> match(char: <span class="string">"*"</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">let</span> num = parseTerm() &#123;</span><br><span class="line">                    number *= num</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> match(char: <span class="string">"/"</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">let</span> num = parseTerm() &#123;</span><br><span class="line">                    number /= num</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> number</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> number</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">parseTerm</span><span class="params">()</span></span> -&gt; <span class="type">Int?</span> &#123;</span><br><span class="line">        <span class="keyword">var</span> number: <span class="type">Int?</span> = <span class="literal">nil</span></span><br><span class="line">        skipBlank()</span><br><span class="line">        <span class="keyword">if</span> match(char: <span class="string">"("</span>) &#123;</span><br><span class="line">            number = parseSum()</span><br><span class="line">            <span class="keyword">if</span> number != <span class="literal">nil</span> &#123;</span><br><span class="line">                skipBlank()</span><br><span class="line">                <span class="keyword">if</span> !match(char: <span class="string">")"</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> match(char: <span class="string">"-"</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">let</span> num = parseTerm() &#123;</span><br><span class="line">                number = -<span class="number">1</span> * num</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            number = parseNumber()</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> number</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">skipBlank</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">while</span> match(char: <span class="string">" "</span>) &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">parseNumber</span><span class="params">()</span></span> -&gt; <span class="type">Int?</span> &#123;</span><br><span class="line">        <span class="keyword">var</span> number = <span class="number">0</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> num = currentCharacter.wholeNumberValue &#123;</span><br><span class="line">            number = num</span><br><span class="line">            </span><br><span class="line">            index += <span class="number">1</span></span><br><span class="line">            <span class="keyword">while</span> index &lt; text.<span class="built_in">count</span>, <span class="keyword">let</span> num2 = currentCharacter.wholeNumberValue &#123;</span><br><span class="line">                skipBlank()</span><br><span class="line">                number = number * <span class="number">10</span> + num2</span><br><span class="line">                index += <span class="number">1</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> number</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">match</span><span class="params">(char: Character)</span></span> -&gt; <span class="type">Bool</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> char == currentCharacter  &#123;</span><br><span class="line">            index += <span class="number">1</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>A json parser with Swift.</strong><br>Inspired by <a href="https://wesleytsai.io/2015/06/13/a-json-parser/" target="_blank" rel="noopener">A JSON Parser</a>、<a href="https://github.com/ming1016/MethodTraceAnalyze" target="_blank" rel="noopener">MethodTraceAnalyze</a> and <a href="http://notes.eatonphil.com/writing-a-simple-json-parser.html" target="_blank" rel="noopener">Writing a simple JSON parser</a></p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Foundation</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> &lt;json&gt;     ::= &lt;value&gt;</span></span><br><span class="line"><span class="comment"> &lt;value&gt;    ::= &lt;object&gt; | &lt;array&gt; | &lt;bool&gt; | &lt;string&gt; | &lt;number&gt; | &lt;null&gt;</span></span><br><span class="line"><span class="comment"> &lt;array&gt;    ::= "[" [&lt;value&gt;] &#123;"," &lt;value&gt;&#125;* "]"</span></span><br><span class="line"><span class="comment"> &lt;object&gt;   ::= "&#123;" [&lt;property&gt;] &#123;"," &lt;property&gt;&#125;* "&#125;"</span></span><br><span class="line"><span class="comment"> &lt;property&gt; ::= &lt;string&gt; ":" &lt;value&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">JSONNumberType</span>: <span class="title">Equatable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">case</span> int(<span class="type">Int</span>)</span><br><span class="line">    <span class="keyword">case</span> double(<span class="type">Double</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">static</span> <span class="function"><span class="keyword">func</span> == <span class="params">(lhs: JSONNumberType, rhs: JSONNumberType)</span></span> -&gt; <span class="type">Bool</span> &#123;</span><br><span class="line">        <span class="keyword">switch</span> (lhs, rhs) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="keyword">let</span> (.int(<span class="keyword">left</span>), .int(<span class="keyword">right</span>)):</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">left</span> == <span class="keyword">right</span></span><br><span class="line">        <span class="keyword">case</span> <span class="keyword">let</span> (.double(<span class="keyword">left</span>), .double(<span class="keyword">right</span>)):</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">left</span> == <span class="keyword">right</span></span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">JSONType</span>: <span class="title">Equatable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">case</span> bool</span><br><span class="line">    <span class="keyword">case</span> string</span><br><span class="line">    <span class="keyword">case</span> number(<span class="type">JSONNumberType</span>)</span><br><span class="line">    <span class="keyword">case</span> null</span><br><span class="line">    <span class="keyword">case</span> array</span><br><span class="line">    <span class="keyword">case</span> object</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">static</span> <span class="function"><span class="keyword">func</span> == <span class="params">(lhs: JSONType, rhs: JSONType)</span></span> -&gt; <span class="type">Bool</span> &#123;</span><br><span class="line">        <span class="keyword">switch</span> (lhs, rhs) &#123;</span><br><span class="line">        <span class="keyword">case</span> (.bool, .bool),</span><br><span class="line">             (.string, .string),</span><br><span class="line">             (.number(<span class="number">_</span>), .number(<span class="number">_</span>)),</span><br><span class="line">             (.null, .null),</span><br><span class="line">             (.array, .array),</span><br><span class="line">             (.object, .object):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">JSONProperty</span>&lt;<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> key: <span class="type">String</span></span><br><span class="line">    <span class="keyword">let</span> value: <span class="type">JSON</span>&lt;<span class="type">V</span>&gt;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">JSON</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> type: <span class="type">JSONType</span></span><br><span class="line">    <span class="keyword">let</span> value: <span class="type">T?</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">JSONSyntaxError</span>: <span class="title">Error</span> </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> line: <span class="type">Int</span></span><br><span class="line">    <span class="keyword">let</span> column: <span class="type">Int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">JSONToken</span>: <span class="title">Equatable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">case</span> string(<span class="type">String</span>, <span class="type">Int</span>, <span class="type">Int</span>)</span><br><span class="line">    <span class="keyword">case</span> number(<span class="type">JSONNumberType</span>, <span class="type">Int</span>, <span class="type">Int</span>)</span><br><span class="line">    <span class="keyword">case</span> bool(<span class="type">Bool</span>, <span class="type">Int</span>, <span class="type">Int</span>)</span><br><span class="line">    <span class="keyword">case</span> null(<span class="type">Int</span>, <span class="type">Int</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">case</span> lBrace(<span class="type">Int</span>, <span class="type">Int</span>) <span class="comment">// &#123;</span></span><br><span class="line">    <span class="keyword">case</span> rBrace(<span class="type">Int</span>, <span class="type">Int</span>) <span class="comment">// &#125;</span></span><br><span class="line">    <span class="keyword">case</span> lBracket(<span class="type">Int</span>, <span class="type">Int</span>) <span class="comment">// [</span></span><br><span class="line">    <span class="keyword">case</span> rBracket(<span class="type">Int</span>, <span class="type">Int</span>) <span class="comment">// [</span></span><br><span class="line">    <span class="keyword">case</span> comma(<span class="type">Int</span>, <span class="type">Int</span>) <span class="comment">// ,</span></span><br><span class="line">    <span class="keyword">case</span> colon(<span class="type">Int</span>, <span class="type">Int</span>) <span class="comment">// :,</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">static</span> <span class="function"><span class="keyword">func</span> ==<span class="params">(lhs: JSONToken, rhs: JSONToken)</span></span> -&gt; <span class="type">Bool</span> &#123;</span><br><span class="line">        <span class="keyword">switch</span> (lhs, rhs) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="keyword">let</span> (.string(<span class="keyword">left</span>, <span class="number">_</span>, <span class="number">_</span>), .string(<span class="keyword">right</span>,  <span class="number">_</span>, <span class="number">_</span>)):</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">left</span> == <span class="keyword">right</span></span><br><span class="line">        <span class="keyword">case</span> <span class="keyword">let</span> (.number(.int(<span class="keyword">left</span>), <span class="number">_</span>, <span class="number">_</span>), .number(.int(<span class="keyword">right</span>), <span class="number">_</span>, <span class="number">_</span>)):</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">left</span> == <span class="keyword">right</span></span><br><span class="line">        <span class="keyword">case</span> <span class="keyword">let</span> (.number(.double(<span class="keyword">left</span>), <span class="number">_</span>, <span class="number">_</span>), .number(.double(<span class="keyword">right</span>), <span class="number">_</span>, <span class="number">_</span>)):</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">left</span> == <span class="keyword">right</span></span><br><span class="line">        <span class="keyword">case</span> <span class="keyword">let</span> (.bool(<span class="keyword">left</span>, <span class="number">_</span>, <span class="number">_</span>), .bool(<span class="keyword">right</span>, <span class="number">_</span>, <span class="number">_</span>)):</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">left</span> == <span class="keyword">right</span></span><br><span class="line">        <span class="keyword">case</span> (.null(<span class="number">_</span>, <span class="number">_</span>), .null(<span class="number">_</span>, <span class="number">_</span>)),</span><br><span class="line">             (.lBrace(<span class="number">_</span>, <span class="number">_</span>), .lBrace(<span class="number">_</span>, <span class="number">_</span>)),</span><br><span class="line">             (.rBrace(<span class="number">_</span>, <span class="number">_</span>), .rBrace(<span class="number">_</span>, <span class="number">_</span>)),</span><br><span class="line">             (.lBracket(<span class="number">_</span>, <span class="number">_</span>), .lBracket(<span class="number">_</span>, <span class="number">_</span>)),</span><br><span class="line">             (.rBracket(<span class="number">_</span>, <span class="number">_</span>), .rBracket(<span class="number">_</span>, <span class="number">_</span>)),</span><br><span class="line">             (.comma(<span class="number">_</span>, <span class="number">_</span>), .comma(<span class="number">_</span>, <span class="number">_</span>)),</span><br><span class="line">             (.colon(<span class="number">_</span>, <span class="number">_</span>), .colon(<span class="number">_</span>, <span class="number">_</span>)):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> lineColumn: (<span class="type">Int</span>, <span class="type">Int</span>) &#123;</span><br><span class="line">        <span class="keyword">switch</span> <span class="keyword">self</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="keyword">let</span> .number(<span class="number">_</span>, line, col):</span><br><span class="line">            <span class="keyword">return</span> (line, col)</span><br><span class="line">        <span class="keyword">case</span> <span class="keyword">let</span> .string(<span class="number">_</span>, line, col):</span><br><span class="line">            <span class="keyword">return</span> (line, col)</span><br><span class="line">        <span class="keyword">case</span> <span class="keyword">let</span> .bool(<span class="number">_</span>, line, col):</span><br><span class="line">            <span class="keyword">return</span> (line, col)</span><br><span class="line">        <span class="keyword">case</span> <span class="keyword">let</span> .null(line, col),</span><br><span class="line">             <span class="keyword">let</span> .lBrace(line, col),</span><br><span class="line">             <span class="keyword">let</span> .rBrace(line, col),</span><br><span class="line">             <span class="keyword">let</span> .lBracket(line, col),</span><br><span class="line">             <span class="keyword">let</span> .rBracket(line, col),</span><br><span class="line">             <span class="keyword">let</span> .comma(line, col),</span><br><span class="line">             <span class="keyword">let</span> .colon(line, col):</span><br><span class="line">            <span class="keyword">return</span> (line, col)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">JSONParser</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> index: <span class="type">Int</span></span><br><span class="line">    <span class="keyword">var</span> currentToken: <span class="type">JSONToken?</span></span><br><span class="line">    <span class="keyword">let</span> tokens: [<span class="type">JSONToken</span>]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> error: <span class="type">JSONSyntaxError</span> &#123;</span><br><span class="line">        <span class="keyword">var</span> (line, col) = (<span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> token = currentToken &#123;</span><br><span class="line">            (line, col) = token.lineColumn</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> <span class="keyword">let</span> token = tokens.last &#123;</span><br><span class="line">            (line, col) = token.lineColumn</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="type">JSONSyntaxError</span>(line: line, column: col)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">static</span> <span class="function"><span class="keyword">func</span> <span class="title">parse</span><span class="params">(text: String)</span></span> <span class="keyword">throws</span> -&gt; <span class="type">JSON</span>&lt;<span class="type">Any</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> tokens = <span class="keyword">try</span> <span class="type">JSONLexer</span>(text).lex()</span><br><span class="line">            <span class="keyword">if</span> tokens.<span class="built_in">count</span> &gt; <span class="number">0</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">try</span> <span class="type">JSONParser</span>(tokens).parse()</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="type">JSON</span>(type: .null, value: <span class="type">JSONType</span>.null)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> <span class="keyword">let</span> e &#123;</span><br><span class="line">            <span class="keyword">throw</span> e</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">init</span>(<span class="number">_</span> tokens: [<span class="type">JSONToken</span>]) &#123;</span><br><span class="line">        <span class="keyword">self</span>.tokens = tokens</span><br><span class="line">        index = <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">parse</span><span class="params">()</span></span> <span class="keyword">throws</span> -&gt; <span class="type">JSON</span>&lt;<span class="type">Any</span>&gt; &#123;</span><br><span class="line">        <span class="built_in">advance</span>()</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">try</span> parseValue()</span><br><span class="line">        &#125; <span class="keyword">catch</span> <span class="keyword">let</span> e &#123;</span><br><span class="line">            <span class="keyword">throw</span> e</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">parseValue</span><span class="params">()</span></span> <span class="keyword">throws</span> -&gt; <span class="type">JSON</span>&lt;<span class="type">Any</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> token = currentToken <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> error</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">switch</span> token &#123;</span><br><span class="line">        <span class="keyword">case</span> .lBrace(<span class="number">_</span>, <span class="number">_</span>):</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">try</span> parseObject()</span><br><span class="line">        <span class="keyword">case</span> .lBracket(<span class="number">_</span>, <span class="number">_</span>):</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">try</span> parseArray()</span><br><span class="line">        <span class="keyword">case</span> <span class="keyword">let</span> .bool(bool, <span class="number">_</span>, <span class="number">_</span>):</span><br><span class="line">            <span class="keyword">return</span> <span class="type">JSON</span>(type: .bool, value: bool)</span><br><span class="line">        <span class="keyword">case</span> .null(<span class="number">_</span>, <span class="number">_</span>):</span><br><span class="line">            <span class="keyword">return</span> <span class="type">JSON</span>(type: .null, value: <span class="type">JSONType</span>.null)</span><br><span class="line">        <span class="keyword">case</span> .string(<span class="keyword">let</span> str, <span class="number">_</span>, <span class="number">_</span>):</span><br><span class="line">            <span class="keyword">return</span> <span class="type">JSON</span>(type: .string, value: str)</span><br><span class="line">        <span class="keyword">case</span> .number(<span class="keyword">let</span> numType, <span class="number">_</span>, <span class="number">_</span>):</span><br><span class="line">            <span class="keyword">return</span> <span class="type">JSON</span>(type: .number(numType), value: numType)</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">throw</span> error</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">parseObject</span><span class="params">()</span></span> <span class="keyword">throws</span> -&gt; <span class="type">JSON</span>&lt;<span class="type">Any</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">var</span> properties = [<span class="type">JSONProperty</span>&lt;<span class="type">Any</span>&gt;]()</span><br><span class="line">        <span class="built_in">advance</span>()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">repeat</span> &#123;</span><br><span class="line">            <span class="keyword">guard</span> <span class="keyword">let</span> token = currentToken <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">throw</span> error</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">switch</span> token &#123;</span><br><span class="line">            <span class="keyword">case</span> .rBrace(<span class="number">_</span>, <span class="number">_</span>):</span><br><span class="line">                <span class="keyword">return</span> <span class="type">JSON</span>(type: .object, value: properties)</span><br><span class="line">            <span class="keyword">case</span> .comma(<span class="number">_</span>, <span class="number">_</span>):</span><br><span class="line">                <span class="built_in">advance</span>()</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                properties.append(<span class="keyword">try</span> parseProperty())</span><br><span class="line">                <span class="built_in">advance</span>()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">while</span> currentToken != <span class="literal">nil</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">throw</span> error</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">parseArray</span><span class="params">()</span></span> <span class="keyword">throws</span> -&gt; <span class="type">JSON</span>&lt;<span class="type">Any</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">var</span> array = [<span class="type">JSON</span>&lt;<span class="type">Any</span>&gt;]()</span><br><span class="line">        <span class="built_in">advance</span>()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">repeat</span> &#123;</span><br><span class="line">            <span class="keyword">guard</span> <span class="keyword">let</span> token = currentToken <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">switch</span> token &#123;</span><br><span class="line">            <span class="keyword">case</span> .rBracket(<span class="number">_</span>, <span class="number">_</span>):</span><br><span class="line">                <span class="keyword">return</span> <span class="type">JSON</span>(type: .array, value: array)</span><br><span class="line">            <span class="keyword">case</span> .comma(<span class="number">_</span>, <span class="number">_</span>):</span><br><span class="line">                <span class="built_in">advance</span>()</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                array.append(<span class="keyword">try</span> parseValue())</span><br><span class="line">                <span class="built_in">advance</span>()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">while</span> currentToken != <span class="literal">nil</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">throw</span> error</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">parseProperty</span><span class="params">()</span></span> <span class="keyword">throws</span> -&gt; <span class="type">JSONProperty</span>&lt;<span class="type">Any</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> token = currentToken <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> error</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">switch</span> token &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="keyword">let</span> .string(str, <span class="number">_</span>, <span class="number">_</span>):</span><br><span class="line">            <span class="built_in">advance</span>()</span><br><span class="line">            <span class="keyword">if</span> currentToken == <span class="type">JSONToken</span>.colon(<span class="number">0</span>, <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">do</span> &#123;</span><br><span class="line">                    <span class="built_in">advance</span>()</span><br><span class="line">                    <span class="keyword">return</span> <span class="type">JSONProperty</span>(key: str, value: <span class="keyword">try</span> parseValue())</span><br><span class="line">                &#125; <span class="keyword">catch</span> <span class="keyword">let</span> e &#123;</span><br><span class="line">                    <span class="keyword">throw</span> e</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">throw</span> error</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">advance</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> index &lt; tokens.<span class="built_in">count</span> &#123;</span><br><span class="line">            currentToken = tokens[index]</span><br><span class="line">            index += <span class="number">1</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            currentToken = <span class="literal">nil</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">JSONLexer</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> column: <span class="type">Int</span></span><br><span class="line">    <span class="keyword">var</span> line: <span class="type">Int</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> index: <span class="type">Int</span></span><br><span class="line">    <span class="keyword">var</span> jsonText: (<span class="type">String</span>)</span><br><span class="line">    <span class="keyword">var</span> currentCharacter: <span class="type">Character?</span></span><br><span class="line">    <span class="keyword">let</span> escape: [<span class="type">Character</span> : <span class="type">String</span>] = [<span class="string">"n"</span> : <span class="string">"\n"</span>,</span><br><span class="line">                                        <span class="string">"t"</span> : <span class="string">"\t"</span>,</span><br><span class="line">                                        <span class="string">"r"</span> : <span class="string">"\r"</span>,</span><br><span class="line">                                        <span class="string">"\\"</span> : <span class="string">"\\"</span>,</span><br><span class="line">                                        <span class="string">"\""</span> : <span class="string">"\""</span>]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> error: <span class="type">JSONSyntaxError</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="type">JSONSyntaxError</span>(line: line, column: column)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">static</span> <span class="function"><span class="keyword">func</span> <span class="title">test</span><span class="params">(jsonText: String, expected: [JSONToken])</span></span> &#123;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> tokens = <span class="keyword">try</span> <span class="type">JSONLexer</span>(jsonText).lex()</span><br><span class="line">            <span class="keyword">if</span> tokens == expected &#123;</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">"Lexer is right."</span>)</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">"Error"</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> <span class="keyword">let</span> e <span class="keyword">as</span> <span class="type">JSONSyntaxError</span> &#123;</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"Error at line \(e.line) column \(e.column)"</span>)</span><br><span class="line">        &#125; <span class="keyword">catch</span> <span class="keyword">let</span> e &#123;</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"Unknown error! \(e.localizedDescription)"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">init</span>(<span class="number">_</span> jsonText: <span class="type">String</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.jsonText = jsonText</span><br><span class="line">        column = <span class="number">1</span></span><br><span class="line">        line = <span class="number">1</span></span><br><span class="line">        index = <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">lex</span><span class="params">()</span></span> <span class="keyword">throws</span> -&gt; [<span class="type">JSONToken</span>] &#123;</span><br><span class="line">        <span class="keyword">guard</span> jsonText.<span class="built_in">count</span> &gt; <span class="number">0</span> <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> error</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">advance</span>()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">var</span> result = [<span class="type">JSONToken</span>]()</span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">let</span> char = currentCharacter &#123;</span><br><span class="line">            <span class="keyword">do</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">let</span> token = <span class="keyword">try</span> lexString() &#123;</span><br><span class="line">                    result.append(token)</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">let</span> token = <span class="keyword">try</span> lexNumber() &#123;</span><br><span class="line">                    result.append(token)</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">let</span> token = <span class="keyword">try</span> lexBool() &#123;</span><br><span class="line">                    result.append(token)</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">let</span> token = <span class="keyword">try</span> lexNull() &#123;</span><br><span class="line">                    result.append(token)</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> <span class="keyword">let</span> e &#123;</span><br><span class="line">                <span class="keyword">throw</span> e</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//  above use advance(false), check blank.</span></span><br><span class="line">            <span class="keyword">if</span> <span class="type">CharacterSet</span>.whitespacesAndNewlines.<span class="built_in">contains</span>(char.unicodeScalars.first!) &#123;</span><br><span class="line">                <span class="built_in">advance</span>()</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">var</span> token: <span class="type">JSONToken?</span></span><br><span class="line">            <span class="keyword">switch</span> char &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">"&#123;"</span>:</span><br><span class="line">                token = .lBrace(line, column)</span><br><span class="line">            <span class="keyword">case</span> <span class="string">"&#125;"</span>:</span><br><span class="line">                token = .rBrace(line, column)</span><br><span class="line">            <span class="keyword">case</span> <span class="string">"["</span>:</span><br><span class="line">                token = .lBracket(line, column)</span><br><span class="line">            <span class="keyword">case</span> <span class="string">"]"</span>:</span><br><span class="line">                token = .rBracket(line, column)</span><br><span class="line">            <span class="keyword">case</span> <span class="string">","</span>:</span><br><span class="line">                token = .comma(line, column)</span><br><span class="line">            <span class="keyword">case</span> <span class="string">":"</span>:</span><br><span class="line">                token = .colon(line, column)</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                token = <span class="literal">nil</span></span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">let</span> tk = token &#123;</span><br><span class="line">                result.append(tk)</span><br><span class="line">                <span class="built_in">advance</span>()</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">throw</span> error</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">advance</span><span class="params">(<span class="number">_</span> skipWhitespace: Bool = <span class="literal">true</span>)</span></span> &#123;</span><br><span class="line">        <span class="keyword">repeat</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> index &lt; jsonText.<span class="built_in">count</span> &#123;</span><br><span class="line">                currentCharacter = jsonText[jsonText.index(jsonText.startIndex, offsetBy: index)]</span><br><span class="line">                <span class="keyword">if</span> currentCharacter == <span class="string">"\n"</span> &#123;</span><br><span class="line">                    line += <span class="number">1</span></span><br><span class="line">                    <span class="comment">// skip newline</span></span><br><span class="line">                    column = <span class="number">0</span></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    column += <span class="number">1</span></span><br><span class="line">                &#125;</span><br><span class="line">                index += <span class="number">1</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                currentCharacter = <span class="literal">nil</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">while</span> skipWhitespace &amp;&amp;</span><br><span class="line">            currentCharacter != <span class="literal">nil</span> &amp;&amp;</span><br><span class="line">            <span class="type">CharacterSet</span>.whitespacesAndNewlines.<span class="built_in">contains</span>((currentCharacter?.unicodeScalars.first)!)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">lexString</span><span class="params">()</span></span> <span class="keyword">throws</span> -&gt; <span class="type">JSONToken?</span> &#123;</span><br><span class="line">        <span class="keyword">guard</span> currentCharacter == <span class="string">"\""</span> <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">advance</span>(<span class="literal">false</span>)</span><br><span class="line">        <span class="keyword">var</span> str = <span class="string">""</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         Not include:</span></span><br><span class="line"><span class="comment">         \f -- Form feed</span></span><br><span class="line"><span class="comment">         \v -- Vertical tab</span></span><br><span class="line"><span class="comment">         \b -- backspace</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">while</span> currentCharacter != <span class="string">"\""</span>  &#123;</span><br><span class="line">            <span class="keyword">if</span> currentCharacter == <span class="string">"\\"</span> &#123;</span><br><span class="line">                <span class="built_in">advance</span>(<span class="literal">false</span>)</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">let</span> char = currentCharacter, <span class="keyword">let</span> escapedChar = escape[char] &#123;</span><br><span class="line">                    str.append(escapedChar)</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">throw</span> error</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> <span class="keyword">let</span> char = currentCharacter &#123;</span><br><span class="line">                str.append(char)</span><br><span class="line">                <span class="built_in">advance</span>(<span class="literal">false</span>)</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">throw</span> error</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">advance</span>()</span><br><span class="line">        <span class="keyword">return</span> .string(str, line, column)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Only support Normal Int or float</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">lexNumber</span><span class="params">()</span></span> <span class="keyword">throws</span> -&gt; <span class="type">JSONToken?</span> &#123;</span><br><span class="line">        <span class="function"><span class="keyword">func</span> <span class="title">getDigits</span><span class="params">()</span></span> -&gt; <span class="type">Int?</span> &#123;</span><br><span class="line">            <span class="keyword">guard</span> <span class="keyword">let</span> char = currentCharacter, char.isWholeNumber <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">var</span> num = <span class="number">0</span></span><br><span class="line">            <span class="keyword">while</span> <span class="keyword">let</span> theNum = currentCharacter?.wholeNumberValue &#123;</span><br><span class="line">                num = num * <span class="number">10</span> + theNum</span><br><span class="line">                <span class="built_in">advance</span>(<span class="literal">false</span>)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> num</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="function"><span class="keyword">func</span> <span class="title">getFraction</span><span class="params">()</span></span> -&gt; <span class="type">Double?</span> &#123;</span><br><span class="line">            <span class="keyword">guard</span> <span class="keyword">let</span> char = currentCharacter, char.isWholeNumber <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">var</span> multiplier = <span class="number">1.0</span></span><br><span class="line">            <span class="keyword">var</span> num = <span class="number">0.0</span></span><br><span class="line">            <span class="keyword">while</span> <span class="keyword">let</span> theNum = currentCharacter?.wholeNumberValue &#123;</span><br><span class="line">                multiplier *= <span class="number">0.1</span></span><br><span class="line">                num = num + multiplier * <span class="type">Double</span>(theNum)</span><br><span class="line">                <span class="built_in">advance</span>(<span class="literal">false</span>)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> num</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> char = currentCharacter,</span><br><span class="line">            (char == <span class="string">"-"</span> || <span class="type">CharacterSet</span>.decimalDigits.<span class="built_in">contains</span>(char.unicodeScalars.first!)) <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">let</span> isNegative = char == <span class="string">"-"</span></span><br><span class="line">        <span class="keyword">var</span> int: <span class="type">Int?</span></span><br><span class="line">        <span class="keyword">var</span> double: <span class="type">Double?</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">var</span> num: <span class="type">Int</span> = <span class="number">0</span></span><br><span class="line">        <span class="comment">// -123</span></span><br><span class="line">        <span class="keyword">if</span> isNegative &#123;</span><br><span class="line">            <span class="built_in">advance</span>(<span class="literal">false</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> theNum = getDigits() &#123;</span><br><span class="line">            num = theNum</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (isNegative) &#123;</span><br><span class="line">                <span class="keyword">throw</span> error</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">let</span> sign = isNegative ? -<span class="number">1</span> : <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> currentCharacter == <span class="string">"."</span> &#123;</span><br><span class="line">            <span class="built_in">advance</span>(<span class="literal">false</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">let</span> fraction = getFraction() &#123;</span><br><span class="line">                double = (<span class="type">Double</span>(num) + fraction) * <span class="type">Double</span>(sign)</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">throw</span> error</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            int = num * sign</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> int != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> .number(.int(int!), line, column)</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> double != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> .number(.double(double!), line, column)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">lexBool</span><span class="params">()</span></span> <span class="keyword">throws</span> -&gt; <span class="type">JSONToken?</span> &#123;</span><br><span class="line">        <span class="keyword">guard</span> currentCharacter == <span class="string">"f"</span> || currentCharacter == <span class="string">"t"</span> <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="function"><span class="keyword">func</span> <span class="title">isBoolString</span><span class="params">(<span class="number">_</span> str: String)</span></span> -&gt; <span class="type">Bool</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> alphanumeric <span class="keyword">in</span> str &#123;</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">let</span> char = currentCharacter, char == alphanumeric &#123;</span><br><span class="line">                    <span class="built_in">advance</span>(<span class="literal">false</span>)</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">var</span> token: <span class="type">JSONToken?</span> = <span class="literal">nil</span></span><br><span class="line">        <span class="keyword">if</span> currentCharacter == <span class="string">"f"</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> isBoolString(<span class="string">"false"</span>) &#123;</span><br><span class="line">                token = .bool(<span class="literal">false</span>, line, column)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> isBoolString(<span class="string">"true"</span>) &#123;</span><br><span class="line">                token = .bool(<span class="literal">true</span>, line, column)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> token == <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> error</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> token</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">lexNull</span><span class="params">()</span></span> <span class="keyword">throws</span> -&gt; <span class="type">JSONToken?</span> &#123;</span><br><span class="line">        <span class="keyword">guard</span> currentCharacter == <span class="string">"n"</span> <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> alphanumeric <span class="keyword">in</span> <span class="string">"null"</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">let</span> char = currentCharacter, char == alphanumeric &#123;</span><br><span class="line">                <span class="built_in">advance</span>(<span class="literal">false</span>)</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">throw</span> error</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> .null(line, column)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>Test for JSONParser.</strong></p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Foundation</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="function"><span class="keyword">func</span> <span class="title">cs</span><span class="params">(current:String, expect:String, des:String)</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="function"><span class="keyword">func</span> <span class="title">cs</span>&lt;T: Equatable&gt;<span class="params">(current:T, expect: T, des: String)</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> current == expect &#123;</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"✅ \(des) ok，符合预期值：\(expect)"</span>)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> msg = <span class="string">"❌ \(des) fail，不符合预期值：\(expect)"</span></span><br><span class="line">            <span class="built_in">print</span>(msg)</span><br><span class="line">            <span class="built_in">assertionFailure</span>(msg)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> jsonTxt = <span class="string">"""</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    "key1": "value1",</span></span><br><span class="line"><span class="string">    "key2": 22,</span></span><br><span class="line"><span class="string">    "key3": &#123;</span></span><br><span class="line"><span class="string">        "subKey1": "subValue1",</span></span><br><span class="line"><span class="string">        "subKey2": 40,</span></span><br><span class="line"><span class="string">        "subKey3":[</span></span><br><span class="line"><span class="string">            &#123;</span></span><br><span class="line"><span class="string">                "sub1Key1": 10,</span></span><br><span class="line"><span class="string">                "sub1Key2":&#123;</span></span><br><span class="line"><span class="string">                    "sub3Key1" : "sub3Value1",</span></span><br><span class="line"><span class="string">                    "sub3Key2" : "sub3Value2"</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string">            &#125;,</span></span><br><span class="line"><span class="string">            &#123;</span></span><br><span class="line"><span class="string">                "sub1Key1": false,</span></span><br><span class="line"><span class="string">                "sub1Key2": 15</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">        ],</span></span><br><span class="line"><span class="string">        "subKey4": [</span></span><br><span class="line"><span class="string">            "value1",</span></span><br><span class="line"><span class="string">            23.23,</span></span><br><span class="line"><span class="string">            "value2",</span></span><br><span class="line"><span class="string">        ],</span></span><br><span class="line"><span class="string">        "subKey5": null,</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestJSON</span>:<span class="title">Test</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">func</span> <span class="title">testJSON</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> item = <span class="keyword">try</span> <span class="type">JSONParser</span>.parse(text: jsonTxt)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">let</span> arr = item.value <span class="keyword">as</span>! <span class="type">Array</span>&lt;<span class="type">JSONProperty</span>&lt;<span class="type">Any</span>&gt;&gt;</span><br><span class="line">            </span><br><span class="line">            cs(current: <span class="string">"\(arr.count)"</span>, expect: <span class="string">"3"</span>, des: <span class="string">"all dic count"</span>)</span><br><span class="line">            cs(current: <span class="string">"\(arr[0].key)"</span>, expect: <span class="string">"key1"</span>, des: <span class="string">"key1"</span>)</span><br><span class="line">            cs(current: <span class="string">"\(arr[0].value.value as! String)"</span>, expect: <span class="string">"value1"</span>, des: <span class="string">"value1"</span>)</span><br><span class="line">            </span><br><span class="line">            cs(current: <span class="string">"\(arr[1].key)"</span>, expect: <span class="string">"key2"</span>, des: <span class="string">"key2"</span>)</span><br><span class="line">            cs(current: arr[<span class="number">1</span>].value.value <span class="keyword">as</span>! <span class="type">JSONNumberType</span>, expect:<span class="type">JSONNumberType</span>.int(<span class="number">22</span>) , des: <span class="string">"value2"</span>)</span><br><span class="line">            </span><br><span class="line">            cs(current: <span class="string">"\(arr[2].key)"</span>, expect: <span class="string">"key3"</span>, des: <span class="string">"key3"</span>)</span><br><span class="line">            <span class="keyword">let</span> arr2kvs = arr[<span class="number">2</span>].value.value <span class="keyword">as</span>! <span class="type">Array</span>&lt;<span class="type">JSONProperty</span>&lt;<span class="type">Any</span>&gt;&gt;</span><br><span class="line">            cs(current: <span class="string">"\(arr2kvs.count)"</span>, expect: <span class="string">"5"</span>, des: <span class="string">"arr2kvs count"</span>)</span><br><span class="line">            cs(current: <span class="string">"\(arr2kvs[0].key)"</span>, expect: <span class="string">"subKey1"</span>, des: <span class="string">"subKey1"</span>)</span><br><span class="line">            cs(current: <span class="string">"\(arr2kvs[0].value.value as! String)"</span>, expect: <span class="string">"subValue1"</span>, des: <span class="string">"subValue1"</span>)</span><br><span class="line">            cs(current: <span class="string">"\(arr2kvs[1].key)"</span>, expect: <span class="string">"subKey2"</span>, des: <span class="string">"subKey2"</span>)</span><br><span class="line">            cs(current: arr2kvs[<span class="number">1</span>].value.value <span class="keyword">as</span>! <span class="type">JSONNumberType</span>, expect: <span class="type">JSONNumberType</span>.int(<span class="number">40</span>), des: <span class="string">"subValue2"</span>)</span><br><span class="line">            cs(current: <span class="string">"\(arr2kvs[2].key)"</span>, expect: <span class="string">"subKey3"</span>, des: <span class="string">"subKey3"</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">let</span> subValue3 = arr2kvs[<span class="number">2</span>].value.value <span class="keyword">as</span>! <span class="type">Array</span>&lt;<span class="type">JSON</span>&lt;<span class="type">Any</span>&gt;&gt;</span><br><span class="line">            cs(current: <span class="string">"\(subValue3.count)"</span>, expect: <span class="string">"2"</span>, des: <span class="string">"subValue3 count"</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">let</span> subValue30Kvs = subValue3[<span class="number">0</span>].value <span class="keyword">as</span>! <span class="type">Array</span>&lt;<span class="type">JSONProperty</span>&lt;<span class="type">Any</span>&gt;&gt;</span><br><span class="line">            cs(current: <span class="string">"\(subValue30Kvs.count)"</span>, expect: <span class="string">"2"</span>, des: <span class="string">"subValue3 kvs count"</span>)</span><br><span class="line">            cs(current: <span class="string">"\(subValue30Kvs[0].key)"</span>, expect: <span class="string">"sub1Key1"</span>, des: <span class="string">"sub1Key1"</span>)</span><br><span class="line">            cs(current: subValue30Kvs[<span class="number">0</span>].value.value <span class="keyword">as</span>! <span class="type">JSONNumberType</span>, expect: <span class="type">JSONNumberType</span>.int(<span class="number">10</span>), des: <span class="string">"sub1Key1 value"</span>)</span><br><span class="line">            cs(current: <span class="string">"\(subValue30Kvs[1].key)"</span>, expect: <span class="string">"sub1Key2"</span>, des: <span class="string">"sub1Key2"</span>)</span><br><span class="line">            <span class="keyword">let</span> subValue30Kvs1ValueKvs = subValue30Kvs[<span class="number">1</span>].value.value <span class="keyword">as</span>! <span class="type">Array</span>&lt;<span class="type">JSONProperty</span>&lt;<span class="type">Any</span>&gt;&gt;</span><br><span class="line">            cs(current: <span class="string">"\(subValue30Kvs1ValueKvs.count)"</span>, expect: <span class="string">"2"</span>, des: <span class="string">"sub1Key2 value kvs count"</span>)</span><br><span class="line">            cs(current: <span class="string">"\(subValue30Kvs1ValueKvs[0].key)"</span>, expect: <span class="string">"sub3Key1"</span>, des: <span class="string">"sub3Key1"</span>)</span><br><span class="line">            cs(current: <span class="string">"\(subValue30Kvs1ValueKvs[0].value.value as! String)"</span>, expect: <span class="string">"sub3Value1"</span>, des: <span class="string">"sub3Value1"</span>)</span><br><span class="line">            cs(current: <span class="string">"\(subValue30Kvs1ValueKvs[1].key)"</span>, expect: <span class="string">"sub3Key2"</span>, des: <span class="string">"sub3Key2"</span>)</span><br><span class="line">            cs(current: <span class="string">"\(subValue30Kvs1ValueKvs[1].value.value as! String)"</span>, expect: <span class="string">"sub3Value2"</span>, des: <span class="string">"sub3Value2"</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">let</span> subValue31Kvs = subValue3[<span class="number">1</span>].value <span class="keyword">as</span>! <span class="type">Array</span>&lt;<span class="type">JSONProperty</span>&lt;<span class="type">Any</span>&gt;&gt;</span><br><span class="line">            cs(current: <span class="string">"\(subValue31Kvs[0].key)"</span>, expect: <span class="string">"sub1Key1"</span>, des: <span class="string">"subValue31Kvs sub1Key1"</span>)</span><br><span class="line">            cs(current: subValue31Kvs[<span class="number">0</span>].value.value <span class="keyword">as</span>! <span class="type">Bool</span>, expect: <span class="literal">false</span>, des: <span class="string">"subValue31Kvs sub1Key1 value"</span>)</span><br><span class="line">            cs(current: <span class="string">"\(subValue31Kvs[1].key)"</span>, expect: <span class="string">"sub1Key2"</span>, des: <span class="string">"subValue31Kvs sub1Key2"</span>)</span><br><span class="line">            cs(current: subValue31Kvs[<span class="number">1</span>].value.value <span class="keyword">as</span>! <span class="type">JSONNumberType</span>, expect: <span class="type">JSONNumberType</span>.int(<span class="number">15</span>), des: <span class="string">"subValue31Kvs sub1Key2 value"</span>)</span><br><span class="line"></span><br><span class="line">            cs(current: <span class="string">"\(arr2kvs[3].key)"</span>, expect: <span class="string">"subKey4"</span>, des: <span class="string">"subKey4"</span>)</span><br><span class="line">            <span class="keyword">let</span> subValue4 = arr2kvs[<span class="number">3</span>].value.value <span class="keyword">as</span>! <span class="type">Array</span>&lt;<span class="type">JSON</span>&lt;<span class="type">Any</span>&gt;&gt;</span><br><span class="line">            cs(current: <span class="string">"\(subValue4.count)"</span>, expect: <span class="string">"3"</span>, des: <span class="string">"subKey4 value array count"</span>)</span><br><span class="line">            cs(current: <span class="string">"\(subValue4[0].value as! String)"</span>, expect: <span class="string">"value1"</span>, des: <span class="string">"subKey4 value array 0 value"</span>)</span><br><span class="line">            cs(current: subValue4[<span class="number">1</span>].value <span class="keyword">as</span>! <span class="type">JSONNumberType</span>, expect: <span class="type">JSONNumberType</span>.double(<span class="number">23.23</span>), des: <span class="string">"subKey4 value array 1 value"</span>)</span><br><span class="line">            cs(current: <span class="string">"\(subValue4[2].value as! String)"</span>, expect: <span class="string">"value2"</span>, des: <span class="string">"subKey4 value array 2 value"</span>)</span><br><span class="line"></span><br><span class="line">            cs(current: <span class="string">"\(arr2kvs[4].key)"</span>, expect: <span class="string">"subKey5"</span>, des: <span class="string">"subKey5"</span>)</span><br><span class="line">            cs(current: arr2kvs[<span class="number">4</span>].value.value <span class="keyword">as</span>! <span class="type">JSONType</span> , expect: <span class="type">JSONType</span>.null, des: <span class="string">"subKey5 value"</span>)</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> <span class="keyword">let</span> e <span class="keyword">as</span> <span class="type">JSONSyntaxError</span> &#123;</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"Syntax error at line \(e.line) column \(e.column)!"</span>)</span><br><span class="line">        &#125; <span class="keyword">catch</span> <span class="keyword">let</span> e &#123;</span><br><span class="line">            <span class="built_in">print</span>(e.localizedDescription)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">TestJSON</span>.testJSON()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//JSONLexer.test(jsonText: "&#123;\"key1\" \n: false&#125;", expected: [.lBrace(0, 0),</span></span><br><span class="line"><span class="comment">//                                                        .string("key1", 0, 0),</span></span><br><span class="line"><span class="comment">//                                                        .colon(0, 0),</span></span><br><span class="line"><span class="comment">//                                                        .bool(false, 0, 0),</span></span><br><span class="line"><span class="comment">//                                                        .rBrace(0, 0)])</span></span><br></pre></td></tr></table></figure>


    </div>

    
    
    

    <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2017/03/18/%E5%9C%A8ac68u%E4%B8%8A%E9%83%A8%E7%BD%B2aria2/" rel="prev" title="在ac68u上部署aria2">
                  <i class="fa fa-angle-left"></i> 在ac68u上部署aria2
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2021/02/27/%E5%A4%96%E7%BD%91https%E8%AE%BF%E9%97%AE%E7%BE%A4%E6%99%96/" rel="next" title="外网https访问群晖">
                  外网https访问群晖 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments gitalk-container"></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">1oo1</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  






  




<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/gitalk/1.8.0/gitalk.css" integrity="sha256-AJnUHL7dBv6PGaeyPQJcgQPDjt/Hn/PvYZde1iqfp8U=" crossorigin="anonymous">

<script class="next-config" data-name="gitalk" type="application/json">{"enable":true,"github_id":"1oo1","repo":"1oo1.github.io","client_id":"c987fabc9cdf1a342a45","client_secret":"23ca1baccec101674826b562b1567c6ffc98c883","admin_user":"1oo1","distraction_free_mode":false,"proxy":"https://cloudflare-cors-anywhere.1oo1.workers.dev/?https://github.com/login/oauth/access_token","language":"zh-CN","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/gitalk/1.8.0/gitalk.min.js","integrity":"sha256-MVK9MGD/XJaGyIghSVrONSnoXoGh3IFxLw0zfvzpxR4="},"path_md5":"bf0fd30426c9d774666ee6e54a92fdd2"}</script>
<script src="/js/third-party/comments/gitalk.js"></script>

</body>
</html>
